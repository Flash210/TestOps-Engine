# ============================================
# GitHub Actions CI/CD Pipeline
# ============================================
# This workflow automates testing whenever code is pushed or a PR is created
# It runs your Playwright + Cucumber tests and generates reports

name: TestOps Engine - E2E Tests

# ============================================
# TRIGGER CONDITIONS
# ============================================
# This section defines WHEN the pipeline runs
on:
  # Trigger on push to these branches
  push:
    branches: 
      - main          # Runs when you push to main branch
      - master        # Runs when you push to master branch
      - develop       # Runs when you push to develop branch
  
  # Trigger on Pull Requests to these branches
  pull_request:
    branches: 
      - main
      - master
      - develop
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      tags:
        description: 'Test tags to run (e.g., @smoke, @positive)'
        required: false
        default: ''

# ============================================
# PERMISSIONS
# ============================================
# Required for the workflow to comment on PRs and deploy to GitHub Pages
permissions:
  contents: write        # Allows pushing to gh-pages branch
  issues: write          # Allows commenting on Pull Requests
  pull-requests: write   # Allows commenting on Pull Requests
  pages: write           # Allows deployment to GitHub Pages
  id-token: write        # Required for GitHub Pages deployment

# ============================================
# JOBS
# ============================================
# Jobs are the main work units - you can have multiple jobs running in parallel
jobs:
  # -------------------------------------------
  # JOB 1: Run E2E Tests
  # -------------------------------------------
  test:
    # Name displayed in GitHub Actions UI
    name: Run E2E Tests on ${{ matrix.os }}
    
    # Strategy allows running tests on multiple environments
    strategy:
      # Don't cancel other jobs if one fails
      fail-fast: false
      matrix:
        # Run tests on these operating systems
        os: [ubuntu-latest]  # You can add: windows-latest, macos-latest
        node-version: [20.x] # Node.js version to use
    
    # The operating system the job runs on
    runs-on: ${{ matrix.os }}
    
    # -------------------------------------------
    # STEPS - Sequential tasks in this job
    # -------------------------------------------
    steps:
      # STEP 1: Checkout code from repository
      # This downloads your code to the GitHub runner
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
      
      # STEP 2: Setup Node.js environment
      # Installs Node.js on the runner
      - name: üü¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # Cache npm dependencies for faster builds
      
      # STEP 3: Install system dependencies and fonts
      # Essential fonts for Playwright screenshots on Ubuntu 24.04
      - name: üîß Install System Dependencies & Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            fonts-liberation \
            fonts-dejavu-core \
            fonts-dejavu-extra \
            fonts-noto-color-emoji \
            fontconfig \
            libfontconfig1 \
            libfreetype6
          # Refresh font cache
          sudo fc-cache -f -v
        # Only run on Linux
        if: runner.os == 'Linux'
      
      # STEP 4: Install dependencies
      # Installs all packages from package.json
      - name: üì¶ Install Dependencies
        run: npm ci  # 'npm ci' is faster and more reliable than 'npm install' for CI
      
      # STEP 5: Install Playwright browsers
      # Playwright needs browser binaries (Chrome, Firefox, etc.)
      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        # --with-deps installs system dependencies needed by browsers
      
      # STEP 6: Run tests
      # Execute your test suite
      - name: üß™ Run E2E Tests
        run: npm test
        # This runs your test script from package.json
        continue-on-error: true  # Continue even if tests fail (to generate reports)
      
      # STEP 7: Run failed tests (optional rerun)
      # Retry failed tests to reduce flakiness
      - name: üîÑ Rerun Failed Tests
        if: failure()  # Only runs if previous step failed
        run: npm run test:failed
        continue-on-error: true
      
      # STEP 8: Upload Test Results as Artifacts
      # Save test reports so you can download them later
      - name: üìä Upload Test Results
        if: always()  # Always run this step, even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: test-results/
          retention-days: 30  # Keep artifacts for 30 days
      
      # STEP 9: Upload Screenshots on Failure
      # Save failure screenshots for debugging
      - name: üì∏ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.os }}
          path: test-results/screenshots/
          retention-days: 30
      
      # STEP 10: Publish Test Report to GitHub Pages (Optional)
      # Makes reports viewable as a website
      - name: üìÑ Deploy Report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'  # Only on main branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./test-results
          destination_dir: reports/${{ github.run_number }}
      
      # STEP 11: Comment PR with Test Results (Optional)
      # Add test summary as a comment on Pull Requests
      - name: üí¨ Comment Test Results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üß™ Test Results\n\n';
            
            try {
              // Read test results (you may need to parse JSON report)
              comment += '‚úÖ Tests completed! Check artifacts for detailed reports.\n';
              comment += `- üìä [View Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
              comment += `- üì∏ Screenshots available in artifacts\n`;
            } catch (error) {
              comment += '‚ö†Ô∏è Could not parse test results\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # -------------------------------------------
  # JOB 2: Test Summary (Optional)
  # -------------------------------------------
  test-summary:
    name: üìã Test Summary
    needs: test  # This job runs after 'test' job completes
    runs-on: ubuntu-latest
    if: always()  # Run even if test job fails
    
    steps:
      - name: üì• Download Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
      
      - name: üìä Generate Summary
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Artifacts uploaded:" >> $GITHUB_STEP_SUMMARY
          echo "- Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Reports" >> $GITHUB_STEP_SUMMARY

  # -------------------------------------------
  # JOB 3: Send Email Notification
  # -------------------------------------------
  send-notification:
    name: üìß Send Email Notification
    needs: [test, test-summary]  # Runs after both test and summary jobs complete
    runs-on: ubuntu-latest
    if: always()  # Always send notification, regardless of test results
    
    steps:
      # STEP 1: Checkout code to access CODE_REVIEW_REPORT.md
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      # STEP 2: Download test results artifacts
      - name: üì• Download Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: ./downloaded-results
      
      # STEP 3: Prepare email content with test results
      - name: üìù Prepare Email Content
        id: prepare-email
        run: |
          # Determine test status
          if [ "${{ needs.test.result }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="PASSED"
            STATUS_COLOR="green"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="FAILED"
            STATUS_COLOR="red"
          fi
          
          # Create email body
          cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background-color: #0366d6; color: white; padding: 20px; text-align: center; }
              .content { padding: 20px; }
              .status { font-size: 24px; font-weight: bold; color: ${STATUS_COLOR}; }
              .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              .info-table th, .info-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
              .info-table th { background-color: #f6f8fa; font-weight: bold; }
              .footer { background-color: #f6f8fa; padding: 15px; text-align: center; font-size: 12px; color: #666; }
              .button { display: inline-block; padding: 10px 20px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>${STATUS_EMOJI} TestOps Engine - Test Execution Report</h1>
            </div>
            <div class="content">
              <p class="status">Status: ${STATUS_TEXT}</p>
              
              <h2>üìä Execution Details</h2>
              <table class="info-table">
                <tr>
                  <th>Workflow Run</th>
                  <td>#${{ github.run_number }}</td>
                </tr>
                <tr>
                  <th>Repository</th>
                  <td>${{ github.repository }}</td>
                </tr>
                <tr>
                  <th>Branch</th>
                  <td>${{ github.ref_name }}</td>
                </tr>
                <tr>
                  <th>Commit</th>
                  <td>${{ github.sha }}</td>
                </tr>
                <tr>
                  <th>Triggered By</th>
                  <td>${{ github.actor }}</td>
                </tr>
                <tr>
                  <th>Timestamp</th>
                  <td>$(date -u '+%Y-%m-%d %H:%M:%S UTC')</td>
                </tr>
              </table>
              
              <h2>üìã Quick Actions</h2>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">View Full Workflow</a>
              <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts" class="button">Download Artifacts</a>
              
              <h2>üìÑ Code Review Report</h2>
              <p>The complete code review report is attached to this email.</p>
              
              <h2>üîç What's Next?</h2>
              <ul>
                <li>Review the test results in the GitHub Actions workflow</li>
                <li>Check the attached code review report for refactoring details</li>
                <li>Download artifacts for detailed test reports and screenshots</li>
                <li>Address any failing tests if status is FAILED</li>
              </ul>
            </div>
            <div class="footer">
              <p>This is an automated notification from TestOps Engine CI/CD Pipeline</p>
              <p>GitHub Actions ‚Ä¢ ${{ github.repository }}</p>
            </div>
          </body>
          </html>
          EOF
          
          echo "Email content prepared successfully"
      
      # STEP 4: Send email notification with report
      - name: üìß Send Email with Test Report
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP server configuration (using Gmail)
          server_address: smtp.gmail.com
          server_port: 587
          secure: true
          
          # Email credentials (stored in GitHub Secrets)
          # You need to add these secrets in your GitHub repository settings
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          
          # Email details
          subject: "${{ needs.test.result == 'success' && '‚úÖ' || '‚ùå' }} TestOps Engine - Pipeline #${{ github.run_number }} - ${{ needs.test.result }}"
          to: houssemltaif77@gmail.com
          from: TestOps Engine CI/CD <${{ secrets.EMAIL_USERNAME }}>
          
          # Email body (HTML format)
          html_body: file://email_body.html
          
       
          
          # Optional: Add priority
          priority: normal

# ============================================
# NOTES FOR BEGINNERS
# ============================================
# 1. SECRETS.GITHUB_TOKEN is automatically provided by GitHub
# 2. Artifacts are downloadable from GitHub Actions UI
# 3. You can view logs for each step in GitHub Actions tab
# 4. Matrix strategy runs jobs in parallel (faster execution)
# 5. 'if: always()' ensures steps run even when tests fail
# 6. Cache speeds up subsequent runs by storing npm packages
# 7. Node.js 20.x is required for Cucumber.js 12.3.0+
# 8. Essential fonts for Ubuntu 24.04: liberation, dejavu, fontconfig
# 9. --with-deps installs browsers AND system dependencies
# 
# ============================================
# EMAIL NOTIFICATION SETUP
# ============================================
# To enable email notifications, you need to configure GitHub Secrets:
# 
# 1. Go to your GitHub repository
# 2. Click Settings ‚Üí Secrets and variables ‚Üí Actions
# 3. Add the following secrets:
#    - EMAIL_USERNAME: Your Gmail address (e.g., your-email@gmail.com)
#    - EMAIL_PASSWORD: Your Gmail App Password (NOT your regular password)
# 
# How to create Gmail App Password:
# 1. Go to your Google Account (myaccount.google.com)
# 2. Security ‚Üí 2-Step Verification (enable if not already)
# 3. App passwords ‚Üí Generate new app password
# 4. Select "Mail" and "Other (Custom name)"
# 5. Copy the 16-character password
# 6. Use this password in EMAIL_PASSWORD secret
# 
# The email will include:
# - Test execution status (PASSED/FAILED)
# - Workflow details (run number, branch, commit, etc.)
# - Links to view full workflow and download artifacts
# - Attached CODE_REVIEW_REPORT.md file

